---
title: 'null'
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r Initial formatting, include=FALSE}
knitr::opts_chunk$set(echo=FALSE)


load("./data/models_fitted_new.RData")

summary$ID_time <- as.numeric(summary$ID_time)
summary$run <-as.factor(summary$run)
summary$tunnel <-as.factor(summary$tunnel)
summary$ID <- as.factor(summary$ID)
summary$FR <- summary$front_true/(summary$front_false+summary$front_true)
summary$ID_press <- paste(summary$ID, summary$npress, sep ="_")


library(nlme)
library(MuMIn)
library(tidyverse)
library(flextable)
library(ggplot2)
library(ggh4x)
devtools::install_github("thomasp85/scico")
library(scico)


```

## Tables for manuscript

**Tab 1** Summary of biological and experimental paramaters for individual eels

```{r Tab 1}

biomasses$ID <- biomasses$ID %>% str_replace_all(c("a" = "A", "b" = "B", "c" = "C", "d" = "D", "e" = "E", "f" = "F", "g" = "G", "h" = "H", "i" = "I"))

align(flextable(biomasses %>%
            left_join((swimtime %>% select(ID, time_d, distance)), by = c("ID_old" = "ID")) %>%
            select("ID", "Length (cm)", "Silvering Index*", "Biomass at start (g)", "Biomass at end (g)", "Fat at start (% WM)", "Fat at end (% WM)", "Silvering Index*", "time_d", "distance") %>%
            mutate(time_d = round(time_d, 1),
                   distance = round(distance, 0)) %>% 
            rename("Swim time (d)" = time_d,
                   "Swimming distance (km)" = distance)) %>% 
  colformat_num(big.mark   = "") %>%
  autofit(add_w = -0.5), align = "center", part = "all")
```

\*according to Durif et al. (2005)\
\
\
\
**Tab 2** Short summary of the model statistics for main effects. Note, that value gives the change in the log of O2-consuption rate per change in one unit of the predictor.

```{r Tab 2}

intervals <- intervals(lme.final)
intervals <- data.frame(intervals$fixed)
intervals <- intervals %>%
            rename(Lower_confidence_limit = lower,
                   Upper_confidence_limit = upper)
result <- as.data.frame(coef(summary(lme.final)))
result$p <- result$'p-value'
result$Parameter <- rownames(result)
intervals$rownames <- rownames(intervals)


flextable(result %>%
  mutate(p = ifelse(p <= 0.001, "<0.001" , round(p, 3))) %>%
  left_join(intervals, by = c("Parameter" = "rownames")) %>%
  mutate("Lower conf. limit" = round(Lower_confidence_limit, 3),
         "Upper conf. limit" = round(Upper_confidence_limit, 3),
         Value = round(Value, 3)) %>%
  select(c('Parameter', 'Value', 'Lower conf. limit', 'Upper conf. limit', 'p')) %>% 
  mutate(Parameter = if_else(Parameter == "(Intercept)", "Intercept", 
                             if_else(Parameter == "temp_mean", "Temperature",
                             if_else(Parameter == "press_mean", "Pressure",
                             if_else(Parameter == "speedBL", "Flow rate",
                             if_else(Parameter == "temp_mean", "Temperature",
                             if_else(Parameter == "tunnel2", "Tunnel 2",
                             if_else(Parameter == "tunnel3", "Tunnel 3",
                             if_else(Parameter == "run2", "Run 2", "Run 3")))))))))) %>%
  autofit() 
 

```

\
\
\
\
\
\
\

## Graphs for the manuscript

```{r Fig 1, dpi = 300}

fig1 <- tag_facet2(
  ggplot(summary, aes(x=ID_time, y=resp)) +
  geom_point(aes(col = temp_mean, shape = as.factor(npress)), size=1.3, alpha = 0.5) +
  theme_bw()+
  theme(text = element_text(size = 8, family = "sans")) +
  theme(legend.key.size = unit(1.8, "cm"),
        legend.key.width = unit(0.3, "cm"),
        legend.title = element_blank())+
  scale_shape_manual(values = c(1, 16))+
  scale_colour_scico(palette = "batlow", name = "temp (°C)")+
  geom_line(aes(x= ID_time, y=exp(predict(lme.final, level = 0))), size = 0.4)+
  geom_line(aes(x= ID_time, y=exp(predict(lme.final)), group = ID), linetype = "dashed", size = 0.4)+
  labs(x = expression(time~(h)), y = expression(O[2]-consumption ~(mg/kg %*% h^-1)))+
  facet_grid(run ~ tunnel, labeller = labeller(tunnel = tunnel.names, run = run.names))+
  guides(shape=FALSE),
  open ="", close ="", hjust = -1.2) 

#add plot with temp for qual check
  ggplot(summary, aes(x=datetime_min, y=temp_mean)) +
    geom_line(aes(col = tunnel))
  

ggsave("Fig1.pdf", fig1, device = "pdf", height = 7, width = 8, dpi = 300)

fig1
```

**Fig 1** Oxygen consumption rate per individual (a-i) over time different at temperatures (color scale) at 1 bar (open circles) and 8 bar (closed circles). Modeled predictions are displayed on the population level (solid line) and for the individual (dashed line). Colour indicates temp in °C\
\
\
\

```{r Fig 2, dpi = 300}


ideal_summary <- ideal %>%
  mutate(group = paste(temp_mean, press_mean, sep = "_")) %>% 
  group_by(group) %>% 
  summarize(mean = mean(resp),
            sd = sd(resp))

fig2 <- ggplot(ideal, aes(x=temp_mean, y=resp)) +
 theme_bw()+
  theme(legend.key.width = unit(1.5, "cm"))+
  theme(text = element_text(size = 8, family = "sans")) +
  #geom_point(data = summary, aes(x=temp_mean, y = resp, shape = as.factor(npress)), size = 0.9, color = "grey75")+
  #scale_shape_manual(values = c(1, 16))+
  geom_smooth(aes(linetype = as.factor(press_mean)), se = F, color = "black", method = "loess", formula = y~x, size = 0.8)+
  labs(linetype = "pressure (bar)", x = "temp (°C)", y = expression(O[2]-consumption ~(mg/kg %*% h^-1)))+
  theme(legend.position = c(.05, .95),
        legend.justification = c("left", "top"),
        legend.margin = margin(6, 6, 6, 6),
        legend.box.background = element_rect(color="black", size=1))+
  guides(shape=FALSE)

ggsave("Fig2.pdf", fig2, device = "pdf", height = 7, width = 8, dpi = 300)

fig2

```

**Fig 2** Predicted oxygen consumption rate at different temperatures and pressures at a swimming speed of 0.6 BL/s.  Difference between 1 and 8 bar is not significant.\
\
\
\
\
\
\

## Graphs/tabs for supplementary

**Tab S1** Summary of

```{r}

calc_n <- summary %>% mutate(indicator = paste(ID, ntemp, npress, sep = "_")) %>% 
                      group_by(indicator) %>% 
                      summarize(n = length(estimate_s))

flextable(biomasses %>%
            select(ID, ID_old) %>% 
            left_join(treattime, by = c("ID_old" = "ID")) %>%
            mutate(ntemp = replace(ntemp, ntemp == "15", 15.5),
                   indicator = paste(ID_old, ntemp, npress, sep = "_")) %>%
            left_join(calc_n, by = "indicator") %>%
            select(-ID_old, -start, -end, -time_h, -indicator) %>%
            mutate(time_d = round(time_d, 1)) %>%
            rename("nominal pressure (bar)" = npress,
                   "nominal temperature (°C)" = ntemp,
                   "swim time (d)" = time_d)) %>% 
          colformat_num(big.mark   = "") %>%
  autofit()

```

**Tab S2** Summary of model AICs

```{r Tab S1}

round_df <- function(x, digits) {
    # round all numeric variables
    # x: data frame 
    # digits: number of digits to round
    numeric_columns <- sapply(x, mode) == 'numeric'
    x[numeric_columns] <-  round(x[numeric_columns], digits)
    x
}




AIC_scores <- flextable(select.lme %>%
         mutate_if(is.numeric, round, 2)) %>%   
  autofit()

FitFlextableToPage <- function(ft, pgwidth = 6){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

FitFlextableToPage(AIC_scores)
 
```

\
\
\
\

```{r Fig S1, dpi = 600}

ggplot(summary, aes(x=speedBL, y=resp)) +
    geom_point(size=0.2)+ 
    theme_bw()+
    theme(text = element_text(size = 8, family = "sans")) +
    xlim(0.4, 0.8)+
    facet_nested(ntemp + npress ~ Letter_ID )+
  labs(linetype = "pressure (bar)", x = "flow rate (body length/s)", y = expression(O[2]-consumption ~(mg/kg %*% h^-1)))+
  theme(axis.text.x = element_text(angle = 45, size = 6))+
  theme(axis.text.y = element_text(size = 8))+
  geom_smooth(method='lm', formula= y~x, se = F, size = 0.7)
```

**Fig S1** Effect of swimming speed on Oxygen consumption rate per Temperature and pressure for each individual
